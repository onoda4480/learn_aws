# セキュリティ・暗号化

## AWS KMS（Key Management Service）

暗号化キーを安全に作成・保管・管理するサービス

### 機能
- 鍵の作成・保管
- 鍵のローテーション（定期的に自動更新）
- アクセス制御（IAMと連携）
- 監査ログ（CloudTrailで記録）

### 暗号化できるもの
- S3 のオブジェクト
- EBS ボリューム
- RDS データベース
- Secrets Manager のシークレット
- Lambda の環境変数 など

### 鍵の種類

| 種類 | 説明 | 料金 |
|-----|------|-----|
| AWS管理キー | AWSが自動作成・管理 | 無料 |
| カスタマー管理キー | 自分で作成・管理 | 有料（$1/月 + 使用料） |
| 外部キー | 自分の鍵を持ち込む | 有料 |

---

## S3マネージドキー / KMS / Secrets Manager の違い

### 役割の違い

```
S3マネージドキー → S3専用の暗号化方式
KMS            → 暗号化キーの管理サービス
Secrets Manager → パスワード等の秘密情報を保管するサービス
```

### 関係性
```
Secrets Manager の中身
        │
        │ KMS の鍵で暗号化されてる
        ▼
      KMS
```

### 比較表

| サービス | 役割 | 保管するもの | 料金 |
|---------|------|------------|------|
| S3マネージドキー（SSE-S3） | S3専用の暗号化方式 | - | 無料 |
| KMS | 暗号化キーの管理 | 暗号化キー | 有料 |
| Secrets Manager | 秘密情報の保管庫 | パスワード、APIキー等 | 有料 |

### 使い分け
- **SSE-S3**：とりあえず暗号化、コスト不要、監査不要な時
- **KMS**：監査・権限制御・コンプライアンス対応が必要な時
- **Secrets Manager**：パスワード・APIキーの安全な保管・自動ローテーション

### S3 の暗号化方式

| 方式 | 誰が鍵を管理 | 特徴 |
|-----|------------|------|
| SSE-S3 | AWS（全自動） | 楽、無料、細かい制御不可 |
| SSE-KMS | 自分（KMS経由） | 誰が使ったか監査可能、有料 |
| SSE-C | 自分（完全自己管理） | 鍵を毎回送る必要あり |

---

## CloudTrail vs CloudWatch

### 役割の違い
```
CloudTrail = 「誰が何をしたか」の記録（防犯カメラ）
CloudWatch = 「システムが今どうなってるか」の監視（体温計）
```

### CloudTrail
- APIコール（操作）を全て記録
- 誰が・いつ・何をしたか
- セキュリティ監査に使う

### CloudWatch
- メトリクス（CPU、メモリ等）を監視
- ログの収集・分析
- アラーム設定（閾値超えで通知）
- ダッシュボードで可視化

### 比較表

| 項目 | CloudTrail | CloudWatch |
|-----|-----------|------------|
| 目的 | 操作の記録 | 状態の監視 |
| 記録するもの | 誰が何をしたか | CPU、メモリ、エラー数等 |
| 主な用途 | セキュリティ監査 | 運用監視・アラート |
| 時間軸 | 過去の行動を調査 | 今の状態をリアルタイム監視 |

### 具体例
```
EC2 が落ちた！

CloudWatch → 「CPU が 100% になって落ちた」（原因）
CloudTrail → 「15:30 に佐藤さんが停止した」（犯人）
```
