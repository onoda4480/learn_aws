# メッセージング・サーバーレス

## SNS + SQS + Lambda の連携パターン（試験頻出）

### 問題：SNS → Lambda 直接だとメッセージが消失する

```
SNS → Lambda ❌ 失敗
SNS → Lambda ❌ リトライ1回目
SNS → Lambda ❌ リトライ2回目
→ リトライ上限超え → メッセージ消失
```

### 解決策：SQS を間に挟む

```
変更前（メッセージ消失の可能性あり）：
  EC2 → SNS → Lambda

変更後（メッセージ消失なし）：
  EC2 → SNS → SQS → Lambda
```

### なぜ SQS を挟むと解決するか
```
SNS → SQS：SQSがメッセージを永続的に保持（消えない）
SQS → Lambda：
  処理成功 → メッセージ削除
  処理失敗 → キューに残る → 再処理
  何度失敗しても消えない
```

### DLQ（デッドレターキュー）
何度リトライしても失敗するメッセージを退避する別のキュー
- 後から原因調査・再処理が可能
- メッセージが完全に消えることがない

### 比較

| 項目 | SNS → Lambda（直接） | SNS → SQS → Lambda |
|-----|-------------------|-------------------|
| メッセージ永続化 | なし | あり |
| リトライ | SNSの制限あり | SQSで何度でも |
| 失敗時 | 消失の可能性 | キューに残る |
| メッセージの確実性 | 低い | 高い |

### 試験ポイント
```
「メッセージの消失を防ぐ」→ SQS を挟む
```
